<!DOCTYPE html>
<!--This comment should only show up on Oliver branch-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>PFAS prototype</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
</head>
  <body>

    <!-- Start of navbar -->
    <nav class="navbar navbar-expand-md" style="background-color: rgb(189, 225, 70);"> <!--navbar-dark bg-dark-->
        <div class="container-fluid">
          <a href="#" class="navbar-brand" style="color: rgb(84, 84, 84);">PFAS Governance Database</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar_supported_content">
            <span class="navbar-toggler-icon"></span>
          </button>
  
          <div class="collapse navbar-collapse" id="navbar_supported_content">
            <ul class="navbar-nav ms-auto mb-2 mb-md-0">
              
              <!-- About This Database Dropdown -->
              <li class="navbar">
                <a class="nav-link " data-bs-toggle="modal" style="color: rgb(84, 84, 84)" href="#modalref">About This Database</a> 
                    <div class="modal fade" id="modalref" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                
                              </button>
                            </div>
                            <div class="modal-body">
                                The Department of Environmental Conservation shall periodically test the drinking water for PFAS contamination, monitor and offer testing for those expose to the contamination, 
                                and inform the public that firefighting gear that contains PFAS is no longer required ADEC has identified PFOS and PFOA and several other PFAS found in AFFF as hazardous substances. Any discharge of PFAS-based AFFF must be reported immediately to the State under 18 AAC 75.
                                The Department of Environmental Conservation shall periodically test the drinking water for PFAS contamination, monitor and offer testing for those expose to the contamination, 
                                and inform the public that firefighting gear that contains PFAS is no longer required ADEC has identified PFOS and PFOA and several other PFAS found in AFFF as hazardous substances. Any discharge of PFAS-based AFFF must be reported immediately to the State under 18 AAC 75.
                                The Department of Environmental Conservation shall periodically test the drinking water for PFAS contamination, monitor and offer testing for those expose to the contamination, 
                                and inform the public that firefighting gear that contains PFAS is no longer required ADEC has identified PFOS and PFOA and several other PFAS found in AFFF as hazardous substances. Any discharge of PFAS-based AFFF must be reported immediately to the State under 18 AAC 75.
                                The Department of Environmental Conservation shall periodically test the drinking water for PFAS contamination, monitor and offer testing for those expose to the contamination, 
                                and inform the public that firefighting gear that contains PFAS is no longer required ADEC has identified PFOS and PFOA and several other PFAS found in AFFF as hazardous substances. Any discharge of PFAS-based AFFF must be reported immediately to the State under 18 AAC 75.
                                The Department of Environmental Conservation shall periodically test the drinking water for PFAS contamination, monitor and offer testing for those expose to the contamination, 
                                and inform the public that firefighting gear that contains PFAS is no longer required ADEC has identified PFOS and PFOA and several other PFAS found in AFFF as hazardous substances. Any discharge of PFAS-based AFFF must be reported immediately to the State under 18 AAC 75.
                            </div>

                          </div>
                        </div>
              <!-- PFAS Project Lab -->
              <li class="navbar">
                <a class="nav-link" style="color: rgb(84, 84, 84)" href="https://pfasproject.com" target="_blank">PFAS Project Lab</a> 
              </li>
            </ul>
  
            <!-- Search Form -->
          </div>
        </div>
    </nav>
      <!-- End of navbar -->
        
        <!--start of container-->
        <div class="container-fluid border" id="content">
        <row class="row">

            <div class="d-flex flex-row sticky-top pb-3" style="background-color: rgb(191, 191, 191); z-index: 2;"> 
                        
                <!--search bar -->
              <form class="d-flex col-11 mt-3" role="search" id="basicSearch">
                <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" id="searchTerm">
                <button class="btn btn-secondary" style="color: rgb(255, 255, 255)" type="submit" id="submitBtn">Search</button>
              </form> 
              
              <!--Export All Button-->
              <div class="container"> 
                <div class="row">
                    <div class="col-11 mt-3 text-right">
                        <button type='button' class='btn btn-secondary'>Export All

                            <!--
                            <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-download' viewBox='0 0 16 16'>
                                <path d='M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z'></path>
                                <path d='M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z'></path>
                            </svg> -->
                        </button>
                    </div>
                </div>
              </div>
            </div>

            <!--dropdown start-->
            <div class="col-3 pt-2" style="background-color: rgb(191, 191, 191);"> 
                <div class="row justify-content-around align-items-center sticky-top-filter">
                    <div class="col">
                        <div class="row mx-1 mb-1">
                            <button id="filterReset" class="btn btn-secondary" type="button">
                              Reset Filters
                            </button>
                        </div>
                        <div class="accordion" id="advanced-search">
                           <!--start of accordion item-->
                           <!--State or federal agency-->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#advSearch1" aria-expanded="false" aria-controls="advSearch1">
                                    State or Federal Agency
                                    </button>
                                    <div id="advSearch1" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="advanced-search">
                                        <div class="accordion-body">
                                            <form class="form-check">
                                                <label class="form-check-label" for="stateSelect">
                                                    State
                                                </label>
                                                <!-- <input class="form-check-input" type="checkbox" value="" id="state"> -->
                                                <select data-width="fit" multiple id="stateSelect" data-selected-text-format="count" data-actions-box="true">
                                                    <!--state options-->
                                                </select>
                                            </form>
                                            <form class="form-check">
                                                <label class="form-check-label" for="fedSelect">
                                                    Federal
                                                </label>
                                                <!-- <input class="form-check-input" type="checkbox" value="" id="federal"> -->
                                                <select data-width="fit" multiple id="fedSelect" data-selected-text-format="count" data-actions-box="true">
                                                    <!--federal options-->
                                                </select>
                                            </form>
                                        </div>
                                    </div>
                            </div>
                            
                            <!--end of accordion item-->

                            <!--start of accordion item-->
                            <!--Date-->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#advOption2" aria-expanded="false" aria-controls="advOption2">
                                    Date
                                    </button>
                                    <div id="advOption2" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="advanced-search">
                                        <div class="accordion-body justify-content-center">
                                            <form>
                                                <input type="number" min="1900" max="2099" step="1" value="" id="dateStart"/>
                                                -
                                                <input type="number" min="1900" max="2099" step="1" value="" id="dateEnd"/>
                                            </form>
                                        </div>
                                    </div>
                            </div>
                            <!--end of accordion item-->

                            <!--start of accordion item-->
                            <!--Type of action-->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#advOption3" aria-expanded="false" aria-controls="advOption3">
                                    Type of Action
                                    </button>
                                    <div id="advOption3" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="advanced-search">
                                        <div class="accordion-body" id="actionTypeBody">
                                            <!--action types injected here-->
                                            <select data-width="fit" multiple id="typeSelect" data-selected-text-format="count" data-actions-box="true">
                                              <!--type options-->
                                          </select>
                                        </div>
                                    </div>
                            </div>
                            <!--end of accordion item-->

                            <!--start of accordion item-->
                            <!--Topic of action-->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFour">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#option4" aria-expanded="false" aria-controls="option4">
                                    Topic of Action
                                    </button>
                                    <div id="option4" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="advanced-search">
                                        <div class="accordion-body" id="actionTopicBody">
                                            <!--action topics injected here-->
                                            <select data-width="fit" multiple id="topicSelect" data-selected-text-format="count" data-actions-box="true">
                                              <!--topic options-->
                                          </select>
                                        </div>
                                    </div>
                            </div>
                            <!--end of accordion item-->
                            <!--start of accordion item-->
                            <!--sort by options-->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFive">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#option5" aria-expanded="false" aria-controls="option5">
                                    Sort
                                    </button>
                                    <div id="option5" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="advanced-search">
                                        <div class="accordion-body" id="sort-by">
                                            <div class="row">
                                                <span class="sort btn btn-secondary" data-sort="Date">Sort by: Date</span>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!--dropdown end-->
            
            <!--cards start-->
            
            <div class="col-9" style="background-color: rgb(191, 191, 191) ;"> 
                <div class="row">
                    <div class="col-lg-12 gy-2 overflow-auto" id="search_results">
                        <div class="list row gy-3 align-items-center">
                            <!--cards injected here-->
                        </div>
                    </div>
                </div>
            <!--sear bar and cards end-->
            </div> 
        <!--end of container--> 

      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js" crossorigin="anonymous" type="text/javascript"></script>
      <script>
      var accordionID = 0;
      var earliestDate = 2023;
      var latestDate = 2023;
      var options = { // list.js options, fill with html template and column names
          valueNames: [
          "Title", 
          "AgencyOrState", 
          "Date", 
          "ActionType", 
          "ActionTopic", 
          "AgenciesAndPlayers", 
          "Summary", 
          "Legislative", 
          "CompanionBills", 
          "PFASDef", 
          "Sources",
          "ID"
      ],
          item:
              function (values){
                  return `<div class='card'>  
                  <div class='card-body'> 
                      <h2 class='card-title ml-3'>  
                      ${values.Title}
              <!--***Name of Governance Action/title goes here***--> 
                          <!--download button--> 
                          <button type='button' class='btn btn-secondary'> 
                              <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-download' viewBox='0 0 16 16'> 
                          <path d='M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z'></path> 
                          <path d='M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z'></path> 
                            </svg> 
                            </button> 
                      </h2> 
                      <!--Actor, Date, Legislation, Topics of Action, and Key Agencies/Players--> 
                      <h5 class='card-actor ml-3'>Federal Agency or State:  
              ${values.AgencyOrState} 
              <!--***Name of Federal Agency/State goes here***--></h5> 
                      <h5 class='card-date ml-3'>Date:  
              ${values.Date}
              <!--***Date of governance goes here***--></h5> 
                      <h5 class='card-type ml-3'>Type of Governance Action:  
              ${values.ActionType} 
              <!--***Type of governance action goes here***--></h5> 
                      <h5 class='card-topicsOfAction ml-3'>Topics of Governance Action:  
              ${values.ActionTopic}
              <!--***Topics of action goes here***--></h5> 
                      <h5 class='card-keyAgencyPlayers ml-3'>Key Agencies and Players:  
              ${values.AgenciesAndPlayers} 
              <!--***Key agencies/players goes here***--></h5> 
                        <!--Accordion${values.ID}Info Start--> 
                        <div class='container mt-4'> 
                          <div id='accordion${values.ID}'> 
                          <!--Summary of Action--> 
                            <div class='card'> 
                              <a class='card-link card-header' data-toggle='collapse' href='#collapseOne${values.ID}' > 
                                Summary of Action 
                              </a> 
                              <div id='collapseOne${values.ID}' class='collapse' data-parent='#accordion${values.ID}'> 
                                <div class='card-body'> 
                                  ${values.Summary}
                              </div> 
                            </div> 
                            <!--Legislative outcome--> 
                            <div class='card'> 
                              <a class='card-link card-header' data-toggle='collapse' href='#collapseTwo${values.ID}' > 
                                Legislative Outcome 
                              </a> 
                              <div id='collapseTwo${values.ID}' class='collapse' data-parent='#accordion${values.ID}'> 
                                <div class='card-body'>   
                                  ${values.Legislative}
                              </div> 
                            </div> 
                            <!--Companion Bills--> 
                            <div class='card'> 
                              <a class='card-link card-header' data-toggle='collapse' href='#collapseThree${values.ID}' > 
                                Companion Bills 
                              </a> 
                              <div id='collapseThree${values.ID}' class='collapse' data-parent='#accordion${values.ID}'> 
                                <div class='card-body'>
                                  ${values.CompanionBills}
                              </div> 
                            </div> 
                            <!--PFAS Definition--> 
                            <div class='card'> 
                              <a class='collapsed card-link card-header' data-toggle='collapse' href='#collapseFour${values.ID}'> 
                                PFAS Definition 
                              </a> 
                              <div id='collapseFour${values.ID}' class='collapse' data-parent='#accordion${values.ID}'> 
                                <div class='card-body'>
                                  ${values.PFASDef}
                                  <!--***PFAS definition goes here***--> 
                                </div> 
                              </div> 
                            </div> 
                            <!--Sources--> 
                            <div class='card'> 
                              <a class='card-link card-header' data-toggle='collapse' href='#collapseFive${values.ID}'> 
                                Sources 
                              </a> 
                              <div id='collapseFive${values.ID}' class='collapse' data-parent='#accordion${values.ID}'> 
                                <div class='card-body'> 
                                  <h6><p>Primary Sources:</p></h6> 
                                  <p><a ${(values.primarySources == 'N/A') ? '':`href=${values.primarySources} class='link-underline-primary' target='_blank'`}>${values.primarySources}<!--***primary sources links goes here and in href***--></a></p> 
                                  <h6><p>Other Impotant Sources:</p></h6> 
                                  <p><a ${(values.secondarySources == 'N/A') ? '':`href=${values.secondarySources} class='link-underline-primary' target='_blank'`}>${values.secondarySources}<!--***other important sources links goes here and in href***--></a></p> 
                                </div> 
                              </div> 
                          </div> 
                      </div> 
                  </div> 
              </div> 
              </div> 
              </div> 
              </div> 
              </div> 
              </div> 
              </div> 
              </div> ` ;
              }
      };
      var values = []; // list.js values (should stay empty)
      var dataList = new List("content", options, values); // list.js object
      const name = document.getElementById("name");
      const email = document.getElementById("email");
      const ID = document.getElementById("id");
      const submitBtn = document.getElementById("submitBtn");      
      const stateSel = document.getElementById("state");
      const fedSel = document.getElementById("federal");
      var stateSelVal = $('#stateSelect').val(); // default vaules for search
      var fedSelVal = $('#fedSelect').val();
      var dateStart = $('#dateStart').val();
      var dateEnd = $('#dateEnd').val();
      var actionTypeVal = [];
      var actionTopicVal = [];

      /*
      start of event listeners
      */
      
      $('#stateSelect').on('change',function() {
          stateSelVal = $(this).val();
          console.log(stateSelVal);
      });
      $('#fedSelect').on('change',function() {
          fedSelVal = $(this).val();
          console.log(fedSelVal);
      });
      $('#dateStart').on('change',function() {
          dateStart = $(this).val();
          console.log(dateStart);
      });
      $('#dateEnd').on('change',function() {
          dateEnd = $(this).val();
          console.log(dateEnd);
      });
      $('#typeSelect').on('change',function() {
          actionTypeVal = $(this).val();
          console.log(actionTypeVal);
      });
      $('#topicSelect').on('change',function() {
          actionTopicVal = $(this).val();
          console.log(actionTopicVal);
      });
      $('#filterReset').on('click', function(){
        resetFilters();
      });
      $('#basicSearch').on("submit", function(e) { 
        e.preventDefault();
        dataList.search($('#searchTerm').val(),['Title','Summary','AgenciesAndPlayers']);     
        megaFilter();
      });
      $('#stateSelect, #fedSelect, #dateStart, #dateEnd, #typeSelect, #topicSelect').on('change', function(e){
        e.preventDefault();
        megaFilter();
      });

      function megaFilter(){

        var filterTopic = true;
        var filterType = true;
        var filterState = true;
        var filterFederal = true;
        var filterDate = true;

        dataList.filter((item)=>{

          if(item == undefined){
            return false;
          }

          if (stateSelVal != ""){
          console.log("searching with state filter");
          filterState = stateSelVal.includes(item.values().AgencyOrState);
          }

          if (fedSelVal != ""){
            console.log("searching with federal filter");
            filterFederal = fedSelVal.includes(item.values().AgencyOrState);     
          }

          if (actionTypeVal != ""){
            console.log("searching with type filter");
            filterType = actionTypeVal.some((type) => { return ((item.values().ActionType).includes((type)))  });
          }

          if (actionTopicVal != ""){
            console.log("searching with topic filter = "+actionTopicVal);
            filterTopic = actionTopicVal.some((topic) => { return ((item.values().ActionTopic).includes((topic)))  });
          }

          if ((dateStart != earliestDate) || (dateEnd != latestDate)){
            console.log("searching with "+ dateStart + " and " + dateEnd);
            filterDate = ((item.values().Date <= dateEnd) && (item.values().Date >= dateStart));
          }

          return filterTopic && filterType && filterState && filterFederal && filterDate;
        })
      };

      async function onSubmit(e) {
          e.preventDefault();
          //getInfo();
      }
      
      function resetFilters(){
        dataList.filter();
        $('#dateStart').val(earliestDate);
        $('#dateEnd').val(latestDate);
        $('select').selectpicker('deselectAll');
        stateSelVal = "";
        fedSelVal = "";
        actionTypeVal = "";
        actionTopicVal = "";
        dateStart = earliestDate;
        dateEnd = latestDate;
      }

      async function getInfo() {
          const res = await fetch('/info', { method: "GET" });
          const info = await res.json();
          console.log(info);

          function makeOptions(items, selectID) {
            items.map((item) =>{
              $(`#${selectID}`).append(
                  "<option>" + item + "</option>"
              )
            });
          }
          makeOptions(info.states, 'stateSelect');
          makeOptions(info.agencies, 'fedSelect');
          makeOptions(info.types, 'typeSelect');
          makeOptions(info.topics, 'topicSelect');

          $('select').selectpicker(); // Apply bootstrap-select to all select tags
          
          info.data.map((item)=>{

              var date = (item[5]);

              if (date < earliestDate){
                earliestDate = date;
                console.log(`earliest data = ${earliestDate}`)
              } 

              if (date > latestDate){
                latestDate = date;
                console.log(`latest data = ${latestDate}`)
              }

              item = item.map(str => str.trim());
              dataList.add({
                  Title: item[1], 
                  AgencyOrState: item[0], 
                  Date: item[5], 
                  ActionType: item[3], 
                  ActionTopic: item[4], 
                  AgenciesAndPlayers: item[10], 
                  Summary: item[9], 
                  Legislative: item[7], 
                  CompanionBills: item[8], 
                  PFASDef: item[11], 
                  primarySources: item[12],
                  secondarySources: item[13],
                  ID: accordionID++
              });
          });
          $('#dateStart').val(earliestDate);
          $('#dateEnd').val(latestDate);
        }
      getInfo();
      </script>
  </body>
</html>
